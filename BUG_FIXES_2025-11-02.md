# Bug Fixes Report - 2025-11-02

## Summary
Fixed critical bugs preventing the onboarding flow from working properly. The main issue was that profile submission failed with a 500 error, causing users to be redirected back to the onboarding page indefinitely.

## Issues Identified and Fixed

### Issue #1: 500 Error on Profile Submission (CRITICAL)

**Symptom:**
```
Submitting profile data: Object
api/profiles/update:1  Failed to load resource: the server responded with a status of 500 ()
[ChatOnboarding] Update profile failed, fallback to creation: Une erreur est survenue
```

**Root Cause:**
The `submitProfile()` function in `ChatOnboarding.tsx` was attempting to:
1. POST to `/api/profiles/update` (which calls a non-existent n8n webhook)
2. Fall back to PUT `/api/profiles` when that fails
3. But the fallback wasn't receiving proper data, so it also failed

**Solution:**
- Completely rewrote `submitProfile()` to directly POST to `/api/profiles`
- Removed dependency on n8n webhook for profile creation
- Added validation of required fields (first_name, email) before submission
- Improved error messaging

**Files Modified:**
- `components/ChatOnboarding.tsx` (lines 301-354)

**Code Changes:**
```typescript
// OLD: Called /api/profiles/update which failed
// NEW: Directly POST to /api/profiles with validation
const createResponse = await fetch('/api/profiles', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(formData),
});
```

---

### Issue #2: Profile Completion Detection Failing

**Symptom:**
```
[Dashboard] Profile incomplete, redirecting to onboarding. Missing fields: Array(13)
```

After successfully creating a profile, users were redirected back to `/onboarding` because the system thought the profile was incomplete.

**Root Cause:**
Field naming inconsistency:
- Database stores fields in **snake_case**: `first_name`, `last_name`, `current_title`, etc.
- Frontend uses **camelCase**: `firstName`, `lastName`, `currentTitle`, etc.
- The `evaluateCandidateProfile()` function checks for required fields but couldn't find them because of the naming mismatch
- When `toCamelCase()` conversion was incomplete, all 13 required fields appeared missing

**Solution:**
Added automatic conversion from snake_case to camelCase in the API response:

1. Created `toCamelCase()` function in `/api/profiles/me/route.ts`
2. Applied conversion to the candidate object before returning to frontend
3. Improved `profileCompletion.ts` to handle both naming conventions

**Files Modified:**
- `app/api/profiles/me/route.ts` (added function, applied conversion)
- `lib/profileCompletion.ts` (improved `getCandidateValue()`)

**Code Changes:**
```typescript
// In /api/profiles/me/route.ts - Convert response
const toCamelCase = (obj: any): any => {
  if (obj === null || obj === undefined) return obj;
  if (Array.isArray(obj)) return obj.map(item => toCamelCase(item));
  if (typeof obj !== 'object') return obj;

  return Object.keys(obj).reduce((result: any, key: string) => {
    const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
    result[camelKey] = toCamelCase(obj[key]);
    return result;
  }, {});
};

const candidateInCamelCase = candidate ? toCamelCase(candidate) : null;
```

---

### Issue #3: Dashboard Profile Updates Failing

**Symptom:**
Users couldn't edit their profile sections in the dashboard. Clicking "Save" in any section would fail silently.

**Root Cause:**
The `PUT /api/profiles/me` endpoint handler was missing. Dashboard was trying to call `PUT /api/profiles/me` but no handler existed for it.

**Solution:**
Implemented complete PUT handler in `/api/profiles/me/route.ts` that:
1. Validates authentication token
2. Converts frontend camelCase to database snake_case
3. Updates the candidate profile via Prisma upsert
4. Converts response back to camelCase

**Files Modified:**
- `app/api/profiles/me/route.ts` (added PUT handler, ~80 lines)

**Code Changes:**
```typescript
export async function PUT(request: NextRequest) {
  // 1. Validate token
  // 2. Map camelCase to snake_case
  const fieldMapping: Record<string, string> = {
    firstName: 'first_name',
    lastName: 'last_name',
    currentTitle: 'current_title',
    // ... etc
  };

  // 3. Update database
  const updated = await prisma.candidate.upsert({
    where: { email },
    update: snakeCaseData,
    create: { ... },
  });

  // 4. Return in camelCase
  return NextResponse.json({ success: true, data: toCamelCase(updated) });
}
```

---

## Fixed Data Flow

### Before
```
User fills chat
  ↓
POST /api/profiles/update (n8n webhook)
  ↓
❌ 500 error - webhook fails
  ↓
Fallback to PUT /api/profiles
  ↓
❌ Fails with bad data
  ↓
User stuck in onboarding loop
```

### After
```
User fills chat
  ↓
POST /api/profiles (Prisma direct)
  ↓
✅ Profile created
  ↓
Redirect to /dashboard
  ↓
GET /api/profiles/me (returns camelCase)
  ↓
✅ Dashboard displays full profile
  ↓
User can edit and PUT /api/profiles/me
  ↓
✅ Updates saved to database
```

---

## Testing Checklist

- [x] Build succeeds: `npm run build`
- [x] No TypeScript errors
- [x] ChatOnboarding no longer calls `/api/profiles/update`
- [ ] Manual test: Fill chat → Check browser console for success message
- [ ] Manual test: Dashboard loads without "redirecting to onboarding"
- [ ] Manual test: Can edit profile sections and save

---

## Files Changed

| File | Changes | Lines |
|------|---------|-------|
| `components/ChatOnboarding.tsx` | Rewrote submitProfile() | 301-354 |
| `app/api/profiles/me/route.ts` | Added toCamelCase(), improved GET, added PUT | +~150 |
| `lib/profileCompletion.ts` | Improved getCandidateValue() | 75-98 |

---

## Deployment Notes

- No database migrations required (no schema changes)
- No environment variable changes needed
- The `/api/profiles/update` endpoint is now unused but left in place for backwards compatibility
- Prisma client automatically handles snake_case ↔ camelCase internally for TypeScript

---

## Related Files (No Changes Needed)

- `lib/chat-config.ts` - Already uses correct snake_case field names
- `app/api/profiles/route.ts` - Already working correctly (POST and GET handlers)
- `prisma/schema.prisma` - Schema fields already in snake_case

---

## Commit Hash
```
267647d Fix critical bugs in onboarding and profile completion flow
```

---

## Next Steps

1. **Deploy changes** to production
2. **Monitor dashboard** for any remaining issues
3. **Review n8n workflows** - The `/api/profiles/update` endpoint is no longer used, but other workflows (cv-generator, job-analyzer, application-sender) should still work
4. **Consider cleanup:** The `/api/profiles/update/route.ts` file can be removed in a future refactor since it's not used anymore

---

*Generated: 2025-11-02*
*Fixed by: Claude Code*
